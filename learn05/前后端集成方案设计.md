# 智能教学助手前后端集成方案设计

## 1. 概述

本文档详细描述了智能教学助手应用的前后端集成方案，包括API接口规范、认证机制、数据传输格式、错误处理策略等关键技术要点。

### 1.1 技术栈

**后端技术栈：**
- Python 3.8+
- FastAPI 框架
- SQLite/MySQL 数据库
- Uvicorn ASGI 服务器
- 阿里云通义千问 API

**前端技术栈：**
- Flutter 3.0+
- Dart 语言
- HTTP/Dio 网络库
- Provider 状态管理
- 跨平台支持（iOS、Android、Web、Desktop）

### 1.2 架构概览

```
┌─────────────────┐    HTTP/HTTPS    ┌─────────────────┐
│   Flutter App   │ ◄──────────────► │   FastAPI       │
│   (前端客户端)    │                  │   (后端服务)      │
└─────────────────┘                  └─────────────────┘
                                              │
                                              ▼
                                     ┌─────────────────┐
                                     │   SQLite/MySQL  │
                                     │   (数据库)       │
                                     └─────────────────┘
```

## 2. API接口规范

### 2.1 基础配置

**服务器地址：**
- 开发环境：`http://127.0.0.1:8000`
- 生产环境：`https://api.yourdomain.com`

**API版本：** v1
**基础路径：** `/api/v1`

### 2.2 请求格式

**请求头：**
```http
Content-Type: application/json; charset=UTF-8
Accept: application/json; charset=UTF-8
Authorization: Bearer <token>  # 需要认证的接口
```

**请求体格式：**
```json
{
  "data": {
    // 具体业务数据
  },
  "metadata": {
    "timestamp": "2024-01-15T10:30:00Z",
    "client_version": "1.0.0",
    "platform": "android"
  }
}
```

### 2.3 响应格式

**统一响应结构：**
```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {
    // 具体业务数据
  },
  "metadata": {
    "timestamp": "2024-01-15T10:30:00Z",
    "request_id": "req_123456789",
    "server_version": "1.0.0"
  }
}
```

**错误响应结构：**
```json
{
  "success": false,
  "code": 400,
  "message": "请求参数错误",
  "error": {
    "type": "ValidationError",
    "details": [
      {
        "field": "username",
        "message": "用户名不能为空"
      }
    ]
  },
  "metadata": {
    "timestamp": "2024-01-15T10:30:00Z",
    "request_id": "req_123456789"
  }
}
```

## 3. 核心API端点

### 3.1 认证模块 (/api/v1/auth)

#### 3.1.1 用户登录
```http
POST /api/v1/auth/login
```

**请求体：**
```json
{
  "username": "teacher001",
  "password": "password123"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "refresh_token_here",
    "expires_in": 3600,
    "user": {
      "id": 1,
      "username": "teacher001",
      "role": "teacher",
      "profile": {
        "name": "张老师",
        "email": "teacher001@school.com"
      }
    }
  }
}
```

#### 3.1.2 刷新Token
```http
POST /api/v1/auth/refresh
```

#### 3.1.3 用户登出
```http
POST /api/v1/auth/logout
```

### 3.2 成绩管理模块 (/api/v1/grades)

#### 3.2.1 获取成绩列表
```http
GET /api/v1/grades?class_id=1&subject=数学&page=1&size=20
```

#### 3.2.2 添加成绩
```http
POST /api/v1/grades
```

**请求体：**
```json
{
  "student_id": 1,
  "subject": "数学",
  "score": 95.5,
  "exam_type": "期中考试",
  "exam_date": "2024-01-15"
}
```

#### 3.2.3 批量导入成绩
```http
POST /api/v1/grades/batch-import
```

#### 3.2.4 更新成绩
```http
PUT /api/v1/grades/{grade_id}
```

#### 3.2.5 删除成绩
```http
DELETE /api/v1/grades/{grade_id}
```

### 3.3 数据分析模块 (/api/v1/analytics)

#### 3.3.1 班级成绩统计
```http
GET /api/v1/analytics/class-statistics?class_id=1&subject=数学
```

#### 3.3.2 学生个人分析
```http
GET /api/v1/analytics/student-analysis/{student_id}
```

#### 3.3.3 年级排名分析
```http
GET /api/v1/analytics/grade-ranking?grade=高一&subject=数学
```

### 3.4 辅导方案模块 (/api/v1/tutoring)

#### 3.4.1 生成辅导方案
```http
POST /api/v1/tutoring/generate-plan
```

**请求体：**
```json
{
  "student_id": 1,
  "subject": "数学",
  "weak_points": ["函数", "几何"],
  "target_score": 90,
  "study_time_per_day": 60
}
```

#### 3.4.2 获取辅导方案列表
```http
GET /api/v1/tutoring/plans?student_id=1
```

#### 3.4.3 更新辅导进度
```http
PUT /api/v1/tutoring/plans/{plan_id}/progress
```

## 4. 认证与授权机制

### 4.1 JWT Token认证

**Token结构：**
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "user_id": 1,
    "username": "teacher001",
    "role": "teacher",
    "exp": 1642248000,
    "iat": 1642244400
  }
}
```

**Token使用流程：**
1. 用户登录成功后，服务器返回access_token和refresh_token
2. 客户端在每次请求中携带access_token
3. 服务器验证token的有效性和权限
4. Token过期时，使用refresh_token获取新的access_token

### 4.2 权限控制

**角色定义：**
- `admin`: 系统管理员
- `teacher`: 教师
- `student`: 学生
- `parent`: 家长

**权限矩阵：**
| 功能模块 | admin | teacher | student | parent |
|---------|-------|---------|---------|--------|
| 用户管理 | ✓ | ✗ | ✗ | ✗ |
| 成绩录入 | ✓ | ✓ | ✗ | ✗ |
| 成绩查看 | ✓ | ✓ | ✓(自己) | ✓(子女) |
| 数据分析 | ✓ | ✓ | ✓(自己) | ✓(子女) |
| 辅导方案 | ✓ | ✓ | ✓(自己) | ✓(子女) |

## 5. 错误处理策略

### 5.1 HTTP状态码规范

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| 200 | 成功 | 请求成功处理 |
| 201 | 创建成功 | 资源创建成功 |
| 400 | 请求错误 | 参数验证失败 |
| 401 | 未认证 | Token无效或过期 |
| 403 | 权限不足 | 无权限访问资源 |
| 404 | 资源不存在 | 请求的资源不存在 |
| 422 | 业务逻辑错误 | 业务规则验证失败 |
| 500 | 服务器错误 | 内部服务器错误 |

### 5.2 错误码定义

```python
class ErrorCode:
    # 通用错误码
    SUCCESS = 200
    INVALID_PARAMS = 400
    UNAUTHORIZED = 401
    FORBIDDEN = 403
    NOT_FOUND = 404
    INTERNAL_ERROR = 500
    
    # 业务错误码
    USER_NOT_FOUND = 1001
    INVALID_PASSWORD = 1002
    TOKEN_EXPIRED = 1003
    GRADE_NOT_FOUND = 2001
    INVALID_SCORE = 2002
    DUPLICATE_GRADE = 2003
```

### 5.3 客户端错误处理

**Flutter端错误处理策略：**

```dart
class ApiResponse {
  final bool success;
  final int code;
  final String message;
  final dynamic data;
  final Map<String, dynamic>? error;
  
  // 错误类型判断
  bool get isNetworkError => code == -1;
  bool get isServerError => code >= 500;
  bool get isClientError => code >= 400 && code < 500;
  bool get isAuthError => code == 401 || code == 403;
}

// 统一错误处理
class ErrorHandler {
  static void handleError(ApiResponse response) {
    if (response.isAuthError) {
      // 跳转到登录页面
      NavigationService.pushAndClearStack('/login');
    } else if (response.isNetworkError) {
      // 显示网络错误提示
      ToastService.showError('网络连接失败，请检查网络设置');
    } else {
      // 显示具体错误信息
      ToastService.showError(response.message);
    }
  }
}
```

## 6. 数据传输优化

### 6.1 分页机制

**请求参数：**
```json
{
  "page": 1,
  "size": 20,
  "sort": "created_at",
  "order": "desc"
}
```

**响应格式：**
```json
{
  "success": true,
  "data": {
    "items": [...],
    "pagination": {
      "current_page": 1,
      "page_size": 20,
      "total_items": 150,
      "total_pages": 8,
      "has_next": true,
      "has_prev": false
    }
  }
}
```

### 6.2 数据压缩

- 启用GZIP压缩
- 大数据量接口使用流式传输
- 图片等静态资源使用CDN

### 6.3 缓存策略

**客户端缓存：**
- 用户信息缓存（本地存储）
- 静态数据缓存（如学科列表）
- 图片缓存

**服务端缓存：**
- Redis缓存热点数据
- 数据库查询结果缓存
- API响应缓存

## 7. 安全措施

### 7.1 数据传输安全

- 使用HTTPS加密传输
- API接口防重放攻击
- 请求签名验证
- 敏感数据加密存储

### 7.2 输入验证

**后端验证：**
```python
from pydantic import BaseModel, validator

class GradeCreateRequest(BaseModel):
    student_id: int
    subject: str
    score: float
    exam_type: str
    
    @validator('score')
    def validate_score(cls, v):
        if not 0 <= v <= 100:
            raise ValueError('成绩必须在0-100之间')
        return v
```

**前端验证：**
```dart
class FormValidator {
  static String? validateScore(String? value) {
    if (value == null || value.isEmpty) {
      return '请输入成绩';
    }
    final score = double.tryParse(value);
    if (score == null || score < 0 || score > 100) {
      return '成绩必须在0-100之间';
    }
    return null;
  }
}
```

### 7.3 API限流

```python
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/v1/auth/login")
@limiter.limit("5/minute")  # 每分钟最多5次登录尝试
async def login(request: Request, ...):
    pass
```

## 8. 性能优化

### 8.1 数据库优化

- 合理设计索引
- 使用连接池
- 读写分离
- 分页查询优化

### 8.2 API性能优化

- 异步处理
- 批量操作接口
- 数据预加载
- 懒加载机制

### 8.3 前端性能优化

- 图片懒加载
- 列表虚拟滚动
- 状态管理优化
- 内存泄漏防护

## 9. 监控与日志

### 9.1 API监控

- 请求响应时间监控
- 错误率统计
- 并发量监控
- 资源使用监控

### 9.2 日志规范

**日志级别：**
- DEBUG: 调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息
- CRITICAL: 严重错误

**日志格式：**
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "INFO",
  "module": "auth",
  "message": "用户登录成功",
  "user_id": 1,
  "ip": "192.168.1.100",
  "request_id": "req_123456789"
}
```

## 10. 部署与运维

### 10.1 环境配置

**开发环境：**
- 本地开发服务器
- SQLite数据库
- 模拟数据

**测试环境：**
- 测试服务器
- MySQL数据库
- 真实数据

**生产环境：**
- 负载均衡
- 数据库集群
- CDN加速
- 监控告警

### 10.2 CI/CD流程

1. 代码提交触发构建
2. 自动化测试
3. 代码质量检查
4. 构建Docker镜像
5. 部署到测试环境
6. 自动化测试验证
7. 部署到生产环境

## 11. 版本管理

### 11.1 API版本策略

- URL路径版本控制：`/api/v1/`, `/api/v2/`
- 向后兼容原则
- 版本废弃通知机制
- 平滑迁移策略

### 11.2 客户端版本管理

- 强制更新机制
- 版本兼容性检查
- 灰度发布
- 回滚策略

## 12. 测试策略

### 12.1 后端测试

- 单元测试
- 集成测试
- API测试
- 性能测试

### 12.2 前端测试

- Widget测试
- 集成测试
- UI测试
- 兼容性测试

### 12.3 端到端测试

- 业务流程测试
- 数据一致性测试
- 异常场景测试

## 13. 总结

本前后端集成方案设计文档详细描述了智能教学助手应用的技术架构、API规范、安全措施、性能优化等关键要点。通过统一的接口规范、完善的错误处理机制、安全的认证授权体系，确保前后端能够高效、稳定地协同工作。

在实施过程中，需要严格按照本文档的规范进行开发，并根据实际情况进行适当调整和优化。同时，要重视测试、监控和运维工作，确保系统的稳定性和可靠性。