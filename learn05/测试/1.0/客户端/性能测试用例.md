# Flutter客户端性能测试用例

## 1. 测试概述

### 1.1 测试目标
- 验证应用启动性能
- 测试页面响应速度
- 监控内存使用情况
- 评估CPU使用率
- 检测内存泄漏
- 验证电池消耗

### 1.2 性能指标
- **启动时间**：冷启动 < 3秒，热启动 < 1秒
- **页面响应**：页面切换 < 300ms
- **数据加载**：列表加载 < 2秒
- **内存使用**：峰值 < 200MB
- **CPU使用率**：平均 < 30%
- **帧率**：保持 60FPS

### 1.3 测试工具
- **Flutter Performance工具**
- **Observatory/DevTools**
- **Platform-specific工具**（Xcode Instruments、Android Profiler）
- **自定义性能监控代码**

## 2. 启动性能测试

### 2.1 冷启动性能测试

#### TC_P001: 应用冷启动时间测试
- **测试目标**：测量应用冷启动时间
- **前置条件**：应用未运行，设备重启
- **测试步骤**：
  1. 确保应用完全关闭
  2. 清理内存缓存
  3. 启动应用并计时
  4. 记录到主页面显示的时间
- **性能指标**：启动时间 < 3秒
- **测试方法**：

```dart
void main() {
  group('启动性能测试', () {
    testWidgets('冷启动时间测试', (WidgetTester tester) async {
      final stopwatch = Stopwatch()..start();
      
      // 启动应用
      await tester.pumpWidget(MyApp());
      await tester.pumpAndSettle();
      
      stopwatch.stop();
      final startupTime = stopwatch.elapsedMilliseconds;
      
      print('冷启动时间: ${startupTime}ms');
      expect(startupTime, lessThan(3000)); // 小于3秒
      
      // 验证主页面已加载
      expect(find.byType(BottomNavigationBar), findsOneWidget);
    });
  });
}
```

#### TC_P002: 热启动性能测试
- **测试目标**：测量应用热启动时间
- **前置条件**：应用在后台运行
- **测试步骤**：
  1. 将应用切换到后台
  2. 等待一段时间
  3. 重新激活应用
  4. 记录恢复时间
- **性能指标**：恢复时间 < 1秒

### 2.2 首屏渲染性能测试

#### TC_P003: 首屏渲染时间测试
- **测试目标**：测量首屏内容渲染时间
- **前置条件**：应用已启动
- **测试步骤**：
  1. 启动应用
  2. 测量第一个有意义内容显示时间
  3. 测量页面完全加载时间
- **性能指标**：首屏渲染 < 1秒

```dart
testWidgets('首屏渲染时间测试', (WidgetTester tester) async {
  final stopwatch = Stopwatch()..start();
  
  await tester.pumpWidget(MyApp());
  
  // 等待第一帧渲染
  await tester.pump();
  final firstFrameTime = stopwatch.elapsedMilliseconds;
  
  // 等待完全加载
  await tester.pumpAndSettle();
  stopwatch.stop();
  final fullLoadTime = stopwatch.elapsedMilliseconds;
  
  print('首帧渲染时间: ${firstFrameTime}ms');
  print('完全加载时间: ${fullLoadTime}ms');
  
  expect(firstFrameTime, lessThan(500));
  expect(fullLoadTime, lessThan(1000));
});
```

## 3. 页面性能测试

### 3.1 页面切换性能测试

#### TC_P004: 底部导航切换性能
- **测试目标**：测量底部导航页面切换响应时间
- **前置条件**：应用已启动到主页
- **测试步骤**：
  1. 点击不同的导航标签
  2. 测量页面切换时间
  3. 重复测试多次取平均值
- **性能指标**：切换时间 < 300ms

```dart
testWidgets('底部导航切换性能测试', (WidgetTester tester) async {
  await tester.pumpWidget(MyApp());
  await tester.pumpAndSettle();
  
  final navigationTabs = ['成绩管理', '学生管理', '备课', '上课'];
  final switchTimes = <int>[];
  
  for (final tab in navigationTabs) {
    final stopwatch = Stopwatch()..start();
    
    await tester.tap(find.text(tab));
    await tester.pumpAndSettle();
    
    stopwatch.stop();
    switchTimes.add(stopwatch.elapsedMilliseconds);
    
    print('切换到$tab耗时: ${stopwatch.elapsedMilliseconds}ms');
  }
  
  final averageTime = switchTimes.reduce((a, b) => a + b) / switchTimes.length;
  print('平均切换时间: ${averageTime}ms');
  
  expect(averageTime, lessThan(300));
});
```

#### TC_P005: 页面路由跳转性能
- **测试目标**：测量页面间路由跳转性能
- **前置条件**：在主页面
- **测试步骤**：
  1. 执行页面跳转操作
  2. 测量跳转时间
  3. 测试返回操作性能
- **性能指标**：跳转时间 < 500ms

### 3.2 列表滚动性能测试

#### TC_P006: 大列表滚动性能测试
- **测试目标**：测试大数据量列表的滚动性能
- **前置条件**：有大量数据的列表页面
- **测试步骤**：
  1. 加载包含1000+项的列表
  2. 执行快速滚动操作
  3. 监控帧率和响应性
- **性能指标**：保持60FPS，无明显卡顿

```dart
testWidgets('大列表滚动性能测试', (WidgetTester tester) async {
  // 创建大量测试数据
  final largeDataSet = List.generate(1000, (index) => 
    Grade(studentName: '学生$index', subject: '数学', score: 80 + (index % 20)));
  
  await tester.pumpWidget(
    MaterialApp(
      home: GradesPage(grades: largeDataSet),
    ),
  );
  await tester.pumpAndSettle();
  
  final listFinder = find.byType(ListView);
  expect(listFinder, findsOneWidget);
  
  // 执行滚动操作并监控性能
  final stopwatch = Stopwatch()..start();
  
  // 快速滚动到底部
  await tester.fling(listFinder, const Offset(0, -5000), 10000);
  await tester.pumpAndSettle();
  
  stopwatch.stop();
  print('滚动到底部耗时: ${stopwatch.elapsedMilliseconds}ms');
  
  // 验证滚动性能
  expect(stopwatch.elapsedMilliseconds, lessThan(2000));
});
```

## 4. 数据加载性能测试

### 4.1 网络数据加载测试

#### TC_P007: API数据加载性能测试
- **测试目标**：测试API数据加载响应时间
- **前置条件**：网络连接正常
- **测试步骤**：
  1. 触发数据加载操作
  2. 测量从请求到数据显示的时间
  3. 测试不同数据量的加载性能
- **性能指标**：数据加载 < 2秒

```dart
testWidgets('API数据加载性能测试', (WidgetTester tester) async {
  await tester.pumpWidget(MyApp());
  await tester.pumpAndSettle();
  
  // 导航到成绩管理页面
  await tester.tap(find.text('成绩管理'));
  await tester.pump();
  
  final stopwatch = Stopwatch()..start();
  
  // 触发数据刷新
  await tester.tap(find.byKey(const Key('refresh_button')));
  
  // 等待加载完成
  await tester.pumpAndSettle();
  
  stopwatch.stop();
  final loadTime = stopwatch.elapsedMilliseconds;
  
  print('数据加载时间: ${loadTime}ms');
  expect(loadTime, lessThan(2000));
  
  // 验证数据已加载
  expect(find.byType(CircularProgressIndicator), findsNothing);
});
```

#### TC_P008: 图片加载性能测试
- **测试目标**：测试图片资源加载性能
- **前置条件**：页面包含图片资源
- **测试步骤**：
  1. 加载包含多张图片的页面
  2. 测量图片加载时间
  3. 监控内存使用情况
- **性能指标**：图片加载 < 1秒

### 4.2 本地数据库性能测试

#### TC_P009: 数据库查询性能测试
- **测试目标**：测试本地数据库查询性能
- **前置条件**：数据库包含大量数据
- **测试步骤**：
  1. 执行复杂查询操作
  2. 测量查询响应时间
  3. 测试不同查询条件的性能
- **性能指标**：查询时间 < 500ms

## 5. 内存性能测试

### 5.1 内存使用监控测试

#### TC_P010: 应用内存使用测试
- **测试目标**：监控应用运行时内存使用情况
- **前置条件**：应用正常运行
- **测试步骤**：
  1. 启动应用并记录初始内存
  2. 执行各种操作
  3. 监控内存使用峰值
  4. 检查内存释放情况
- **性能指标**：峰值内存 < 200MB

```dart
void main() {
  group('内存性能测试', () {
    test('内存使用监控', () async {
      // 获取初始内存使用
      final initialMemory = await getMemoryUsage();
      print('初始内存使用: ${initialMemory}MB');
      
      // 执行内存密集操作
      final largeList = List.generate(10000, (index) => 
        'Large string data item $index with lots of content');
      
      final peakMemory = await getMemoryUsage();
      print('峰值内存使用: ${peakMemory}MB');
      
      // 清理数据
      largeList.clear();
      
      // 强制垃圾回收
      await forceGarbageCollection();
      
      final finalMemory = await getMemoryUsage();
      print('清理后内存使用: ${finalMemory}MB');
      
      expect(peakMemory, lessThan(200));
      expect(finalMemory, lessThan(initialMemory + 50));
    });
  });
}
```

#### TC_P011: 内存泄漏检测测试
- **测试目标**：检测应用是否存在内存泄漏
- **前置条件**：应用运行一段时间
- **测试步骤**：
  1. 重复执行相同操作
  2. 监控内存使用趋势
  3. 检查内存是否持续增长
- **性能指标**：无明显内存泄漏

### 5.2 大数据处理性能测试

#### TC_P012: 大数据集处理测试
- **测试目标**：测试处理大数据集的性能
- **前置条件**：准备大量测试数据
- **测试步骤**：
  1. 加载大数据集
  2. 执行数据处理操作
  3. 监控内存和CPU使用
- **性能指标**：处理时间合理，资源使用稳定

## 6. CPU性能测试

### 6.1 CPU使用率监控测试

#### TC_P013: CPU使用率测试
- **测试目标**：监控应用CPU使用率
- **前置条件**：应用正常运行
- **测试步骤**：
  1. 执行CPU密集型操作
  2. 监控CPU使用率
  3. 测试多线程性能
- **性能指标**：平均CPU使用率 < 30%

```dart
testWidgets('CPU使用率测试', (WidgetTester tester) async {
  await tester.pumpWidget(MyApp());
  await tester.pumpAndSettle();
  
  // 执行CPU密集型操作
  final stopwatch = Stopwatch()..start();
  
  // 模拟复杂计算
  for (int i = 0; i < 1000000; i++) {
    final result = i * i + i / 2;
  }
  
  stopwatch.stop();
  print('CPU密集型操作耗时: ${stopwatch.elapsedMilliseconds}ms');
  
  // 验证应用仍然响应
  await tester.tap(find.text('成绩管理'));
  await tester.pumpAndSettle();
  
  expect(find.text('成绩管理'), findsOneWidget);
});
```

## 7. 渲染性能测试

### 7.1 帧率测试

#### TC_P014: 动画帧率测试
- **测试目标**：测试动画和过渡效果的帧率
- **前置条件**：页面包含动画效果
- **测试步骤**：
  1. 触发动画效果
  2. 监控帧率
  3. 检查是否有掉帧
- **性能指标**：保持60FPS

#### TC_P015: 复杂UI渲染测试
- **测试目标**：测试复杂UI的渲染性能
- **前置条件**：复杂的UI布局
- **测试步骤**：
  1. 渲染复杂UI组件
  2. 测量渲染时间
  3. 监控GPU使用情况
- **性能指标**：渲染时间 < 16ms（60FPS）

## 8. 电池消耗测试

### 8.1 电池使用监控测试

#### TC_P016: 电池消耗测试
- **测试目标**：监控应用电池消耗情况
- **前置条件**：在真实设备上运行
- **测试步骤**：
  1. 记录初始电池电量
  2. 运行应用一段时间
  3. 记录电池消耗量
  4. 对比同类应用
- **性能指标**：电池消耗在合理范围内

## 9. 网络性能测试

### 9.1 网络请求性能测试

#### TC_P017: 网络请求响应时间测试
- **测试目标**：测试网络请求的响应时间
- **前置条件**：网络连接正常
- **测试步骤**：
  1. 发起网络请求
  2. 测量响应时间
  3. 测试不同网络条件下的性能
- **性能指标**：响应时间 < 3秒

#### TC_P018: 离线缓存性能测试
- **测试目标**：测试离线缓存的读取性能
- **前置条件**：有缓存数据
- **测试步骤**：
  1. 断开网络连接
  2. 访问缓存数据
  3. 测量读取时间
- **性能指标**：缓存读取 < 100ms

## 10. 性能测试工具和方法

### 10.1 Flutter性能工具

```bash
# 启动性能监控
flutter run --profile

# 使用Observatory
flutter run --observatory-port=8888

# 生成性能报告
flutter drive --profile --target=test_driver/perf_test.dart
```

### 10.2 自定义性能监控

```dart
class PerformanceMonitor {
  static final Stopwatch _stopwatch = Stopwatch();
  
  static void startTiming(String operation) {
    print('开始监控: $operation');
    _stopwatch.reset();
    _stopwatch.start();
  }
  
  static void endTiming(String operation) {
    _stopwatch.stop();
    final elapsed = _stopwatch.elapsedMilliseconds;
    print('$operation 耗时: ${elapsed}ms');
  }
  
  static Future<double> getMemoryUsage() async {
    // 获取内存使用情况的实现
    return 0.0;
  }
}
```

### 10.3 性能基准测试

```dart
void main() {
  group('性能基准测试', () {
    benchmark('列表渲染性能', () async {
      final items = List.generate(1000, (i) => 'Item $i');
      
      return await runBenchmark(() async {
        // 执行性能测试代码
      });
    });
  });
}
```

## 11. 性能测试报告模板

### 11.1 测试结果记录

| 测试项目 | 性能指标 | 实际结果 | 是否通过 | 备注 |
|---------|---------|---------|---------|------|
| 冷启动时间 | < 3秒 | 2.1秒 | ✅ | 符合要求 |
| 热启动时间 | < 1秒 | 0.8秒 | ✅ | 符合要求 |
| 页面切换 | < 300ms | 250ms | ✅ | 符合要求 |
| 数据加载 | < 2秒 | 1.5秒 | ✅ | 符合要求 |
| 内存使用 | < 200MB | 180MB | ✅ | 符合要求 |

### 11.2 性能优化建议

1. **启动优化**：
   - 延迟加载非关键组件
   - 优化初始化流程
   - 减少启动时的网络请求

2. **内存优化**：
   - 及时释放不用的资源
   - 使用对象池减少GC压力
   - 优化图片缓存策略

3. **渲染优化**：
   - 减少不必要的重建
   - 使用const构造函数
   - 优化复杂布局

---

**文档版本**：1.0  
**创建日期**：2024年1月  
**测试类型**：性能测试  
**覆盖范围**：启动、页面、内存、CPU、渲染性能