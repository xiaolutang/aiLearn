# 智能教学助手后端架构设计文档

## 1. 系统架构概述

### 1.1 整体架构

基于产品需求和现有技术基础，我们设计了一个模块化、可扩展的后端架构，采用以下分层设计：

```
┌─────────────────────────────────────────────────────────────────┐
│                      前端应用层 (Flutter)                         │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                      API 网关/反向代理                           │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                      业务服务层 (FastAPI)                         │
│  ┌───────────────┐  ┌───────────────┐  ┌─────────────────────┐   │
│  │  备课模块     │  │  上课模块     │  │  成绩模块          │   │
│  └───────────────┘  └───────────────┘  └─────────────────────┘   │
│                                                                 │
│  ┌───────────────┐  ┌───────────────┐  ┌─────────────────────┐   │
│  │  用户管理     │  │  大模型集成   │  │  通知系统          │   │
│  └───────────────┘  └───────────────┘  └─────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                      数据访问层 (ORM)                             │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                      数据库层 (SQLite/MySQL)                      │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

- **Web框架**: FastAPI (高性能、自动生成API文档、类型提示支持)
- **数据库**: SQLite (开发环境)，MySQL (生产环境)
- **ORM**: SQLAlchemy (提供对象关系映射)
- **大模型集成**: OpenAI API、阿里云通义千问API
- **数据处理**: Pandas、NumPy (用于数据导入和分析)
- **API文档**: Swagger/OpenAPI (自动生成)
- **认证授权**: JWT (JSON Web Token)
- **异步支持**: FastAPI原生异步支持
- **缓存**: Redis (可选，用于性能优化)

## 2. 数据库设计

### 2.1 现有数据库结构分析

当前项目已实现以下表结构：

- **students**: 学生基本信息
- **classes**: 班级信息
- **teachers**: 教师信息
- **subjects**: 科目信息
- **grades**: 成绩信息
- **courses**: 课程安排信息
- **attendance**: 考勤信息
- **class_performance**: 课堂表现信息

### 2.2 数据库结构优化

根据产品需求，我们需要扩展现有数据库结构，添加以下表：

```sql
-- 用户表（扩展现有teacher和student表的认证功能）
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,  -- 加密存储
    role TEXT NOT NULL CHECK(role IN ('teacher', 'student', 'parent', 'admin')),
    related_id INTEGER,      -- 关联到teacher_id或student_id
    email TEXT UNIQUE,
    phone_number TEXT UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 教材表
CREATE TABLE IF NOT EXISTS textbooks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    version TEXT,
    subject TEXT NOT NULL,
    grade INTEGER NOT NULL,
    publisher TEXT,
    chapters TEXT,  -- JSON格式存储章节信息
    knowledge_points TEXT,  -- JSON格式存储知识点信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 学情表
CREATE TABLE IF NOT EXISTS learning_status (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id INTEGER NOT NULL,
    knowledge_point TEXT NOT NULL,
    mastery_level INTEGER CHECK(mastery_level BETWEEN 1 AND 10),
    weakness_analysis TEXT,
    improvement_suggestions TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_id) REFERENCES students(student_id)
);

-- 教学资源表
CREATE TABLE IF NOT EXISTS teaching_resources (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    type TEXT NOT NULL CHECK(type IN ('教案', '课件', '练习题', '视频', '其他')),
    content TEXT,  -- 或文件路径
    file_path TEXT,
    author_id INTEGER NOT NULL,
    subject TEXT NOT NULL,
    grade INTEGER NOT NULL,
    tags TEXT,  -- JSON格式存储标签
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (author_id) REFERENCES teachers(teacher_id)
);

-- 辅导方案表
CREATE TABLE IF NOT EXISTS tutoring_plans (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id INTEGER NOT NULL,
    plan_content TEXT NOT NULL,
    resources TEXT,  -- JSON格式存储推荐资源列表
    progress INTEGER CHECK(progress BETWEEN 0 AND 100) DEFAULT 0,
    effect_evaluation TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_id) REFERENCES students(student_id)
);

-- 消息通知表
CREATE TABLE IF NOT EXISTS notifications (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## 3. API接口设计

### 3.1 接口规范

- 遵循RESTful设计原则
- 统一的响应格式：
  ```json
  {
    "code": 0,         // 状态码，0表示成功
    "message": "成功", // 消息描述
    "data": { ... }    // 具体数据
  }
  ```
- 统一的错误处理机制
- 使用JWT进行身份认证
- 支持分页查询：`?page=1&page_size=10`
- 支持排序：`?sort_by=created_at&sort_order=desc`

### 3.2 核心API接口

#### 3.2.1 用户认证相关接口

- `POST /api/auth/login`: 用户登录
- `POST /api/auth/logout`: 用户登出
- `POST /api/auth/register`: 用户注册
- `POST /api/auth/reset-password`: 重置密码
- `GET /api/auth/me`: 获取当前用户信息

#### 3.2.2 成绩管理相关接口

- `GET /api/grades`: 获取成绩列表
- `GET /api/grades/{id}`: 获取单个成绩详情
- `POST /api/grades`: 创建成绩记录
- `PUT /api/grades/{id}`: 更新成绩记录
- `DELETE /api/grades/{id}`: 删除成绩记录
- `POST /api/grades/batch-import`: 批量导入成绩（Excel）
- `GET /api/grades/analysis/class/{class_id}`: 获取班级成绩分析
- `GET /api/grades/analysis/student/{student_id}`: 获取学生成绩分析

#### 3.2.3 学生管理相关接口

- `GET /api/students`: 获取学生列表
- `GET /api/students/{id}`: 获取单个学生详情
- `POST /api/students`: 创建学生记录
- `PUT /api/students/{id}`: 更新学生记录
- `DELETE /api/students/{id}`: 删除学生记录

#### 3.2.4 班级管理相关接口

- `GET /api/classes`: 获取班级列表
- `GET /api/classes/{id}`: 获取单个班级详情
- `POST /api/classes`: 创建班级记录
- `PUT /api/classes/{id}`: 更新班级记录
- `DELETE /api/classes/{id}`: 删除班级记录

#### 3.2.5 辅导方案相关接口

- `GET /api/tutoring-plans`: 获取辅导方案列表
- `GET /api/tutoring-plans/{id}`: 获取单个辅导方案详情
- `POST /api/tutoring-plans`: 创建辅导方案
- `PUT /api/tutoring-plans/{id}`: 更新辅导方案
- `DELETE /api/tutoring-plans/{id}`: 删除辅导方案
- `POST /api/tutoring-plans/generate/{student_id}`: 生成个性化辅导方案
- `PUT /api/tutoring-plans/{id}/progress`: 更新辅导方案进度

#### 3.2.6 大模型交互接口

- `POST /api/ai/query`: 自然语言查询接口（现有功能）
- `POST /api/ai/textbook-analysis`: 教材分析
- `POST /api/ai/teaching-strategy`: 教学策略推荐
- `POST /api/ai/exercise-generation`: 练习题生成

## 4. 大模型集成设计

### 4.1 集成架构

我们将实现一个统一的大模型调用接口，支持多种大模型（如OpenAI、阿里云通义千问等）的无缝切换。

```
┌───────────────┐      ┌────────────────┐      ┌─────────────────────┐
│  业务逻辑层   │ ──→  │ 大模型适配器层 │ ──→  │ 具体大模型API实现   │
└───────────────┘      └────────────────┘      └─────────────────────┘
```

### 4.2 核心功能模块

1. **大模型配置管理**
   - 支持动态切换不同的大模型服务
   - 统一的配置格式

2. **提示词优化**
   - 针对不同场景（教材分析、学情分析、辅导方案等）优化提示词
   - 实现提示词模板管理

3. **上下文管理**
   - 维护对话上下文
   - 支持长对话的分段处理

4. **速率限制处理**
   - 实现请求排队和重试机制
   - 监控API调用频率

5. **错误处理**
   - 统一的错误处理和重试策略
   - 支持降级到其他大模型服务

## 5. 核心业务逻辑实现

### 5.1 成绩管理模块

1. **成绩录入功能**
   - 支持手动录入
   - 支持Excel批量导入（使用pandas处理）
   - 实现数据校验和错误处理机制

2. **成绩分析功能**
   - 计算总分、平均分、排名等基本统计数据
   - 实现多维度筛选和对比分析
   - 支持生成成绩报告

3. **数据可视化接口**
   - 提供成绩分布数据
   - 提供进步趋势数据

### 5.2 学生个性化分析模块

1. **学情分析**
   - 分析学生知识点掌握情况
   - 识别薄弱环节

2. **个性化练习生成**
   - 基于学情分析结果生成针对性练习
   - 支持练习题的详细解析和知识点讲解

3. **辅导方案生成**
   - 基于学生特点和成绩分析生成个性化辅导方案
   - 推荐适合学生的学习资源和方法
   - 支持辅导进度跟踪和调整

### 5.3 用户管理模块

1. **身份认证**
   - 实现JWT认证机制
   - 支持多种登录方式（账号密码、手机验证码等）

2. **权限管理**
   - 基于角色的访问控制（RBAC）
   - 细粒度的权限控制

3. **用户信息管理**
   - 个人信息维护
   - 密码修改等安全操作

## 6. 系统安全与优化

### 6.1 安全措施

1. **数据安全**
   - 敏感数据加密存储（如密码使用bcrypt加密）
   - 数据传输使用HTTPS

2. **认证与授权**
   - 实现JWT令牌认证
   - 细粒度的权限控制

3. **防SQL注入**
   - 使用参数化查询
   - 输入数据校验和清洗

4. **请求限流**
   - 防止恶意请求和DoS攻击

### 6.2 性能优化

1. **数据库优化**
   - 合理设计索引
   - 优化查询语句
   - 使用连接池管理数据库连接

2. **缓存机制**
   - 使用Redis缓存热点数据
   - 实现API响应缓存

3. **异步处理**
   - 使用FastAPI的异步特性处理并发请求
   - 实现耗时操作的异步处理

4. **负载均衡**
   - 支持多实例部署和负载均衡

## 7. 部署方案

### 7.1 开发环境

- 使用SQLite数据库
- 本地运行FastAPI服务
- 支持热重载开发模式

### 7.2 生产环境

- 数据库迁移到MySQL
- 使用Docker容器化部署
- Nginx作为反向代理
- 配置HTTPS证书
- 实现监控和日志收集

## 8. 实施计划

### 8.1 第一阶段（核心功能开发）

- 完善用户管理模块
- 优化成绩管理模块，实现Excel批量导入
- 实现班级及学生管理的基本功能
- 完成基础API文档编写

### 8.2 第二阶段（AI功能集成）

- 实现大模型集成架构
- 开发教材分析功能
- 实现学情分析和个性化辅导方案生成
- 优化大模型调用性能

### 8.3 第三阶段（系统优化与测试）

- 完善系统安全措施
- 性能优化与压力测试
- 功能测试与Bug修复
- 编写部署和运维文档

---
**文档版本**：v1.0
**编写日期**：2023年XX月XX日
**审核人员**：XXX