# æ™ºèƒ½æ•™å­¦åŠ©æ‰‹åç«¯ç³»ç»Ÿä¼˜åŒ–å®æ–½æ–¹æ¡ˆ

## 1. é¡¹ç›®ç°çŠ¶åˆ†æ

### 1.1 å½“å‰æ¶æ„ä¼˜åŠ¿
- âœ… åŸºäºFastAPIçš„ç°ä»£åŒ–Webæ¡†æ¶
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼ŒåŠŸèƒ½åˆ†ç¦»æ¸…æ™°
- âœ… SQLAlchemy ORMæ•°æ®è®¿é—®å±‚
- âœ… å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†
- âœ… å¤§æ¨¡å‹é›†æˆåŸºç¡€æ¶æ„

### 1.2 å·²è§£å†³çš„é—®é¢˜
- âœ… ä¿®å¤äº†æ¨¡å—å¯¼å…¥è·¯å¾„é—®é¢˜
- âœ… åç«¯æœåŠ¡æˆåŠŸå¯åŠ¨
- âœ… APIæ–‡æ¡£å¯æ­£å¸¸è®¿é—® (http://localhost:8001/docs)

### 1.3 å¾…ä¼˜åŒ–çš„å…³é”®é—®é¢˜
- ğŸ”§ APIæ¥å£è§„èŒƒåŒ–å’Œç»Ÿä¸€å“åº”æ ¼å¼
- ğŸ”§ æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
- ğŸ”§ å¤§æ¨¡å‹é›†æˆçš„ç¨³å®šæ€§å’Œæ€§èƒ½
- ğŸ”§ é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æœºåˆ¶
- ğŸ”§ APIå®‰å…¨æ€§å¢å¼º

## 2. åç«¯ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆ

### 2.1 APIæ¶æ„ä¼˜åŒ–

#### 2.1.1 ç»Ÿä¸€å“åº”æ ¼å¼
```python
# æ ‡å‡†APIå“åº”æ ¼å¼
class APIResponse(BaseModel):
    success: bool
    message: str
    data: Optional[Any] = None
    error_code: Optional[str] = None
    timestamp: datetime = Field(default_factory=datetime.now)
```

#### 2.1.2 APIç‰ˆæœ¬ç®¡ç†
- å®æ–½APIç‰ˆæœ¬æ§åˆ¶ `/api/v1/`
- å‘åå…¼å®¹æ€§ä¿è¯
- æ¸…æ™°çš„ç‰ˆæœ¬è¿ç§»è·¯å¾„

#### 2.1.3 è¯·æ±‚éªŒè¯å¢å¼º
- Pydanticæ¨¡å‹éªŒè¯
- è¾“å…¥æ•°æ®æ¸…æ´—å’Œè½¬æ¢
- ä¸šåŠ¡é€»è¾‘éªŒè¯

### 2.2 æ•°æ®åº“ä¼˜åŒ–

#### 2.2.1 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
```sql
-- å…³é”®ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_grade_student_subject ON grades(student_id, subject_id);
CREATE INDEX idx_grade_class_date ON grades(class_id, created_at);
CREATE INDEX idx_user_username ON users(username);
```

#### 2.2.2 æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
```python
# è¿æ¥æ± é…ç½®ä¼˜åŒ–
engine = create_engine(
    DATABASE_URL,
    pool_size=20,
    max_overflow=30,
    pool_pre_ping=True,
    pool_recycle=3600
)
```

#### 2.2.3 æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
- ä½¿ç”¨eager loadingå‡å°‘N+1æŸ¥è¯¢
- å®æ–½æŸ¥è¯¢ç¼“å­˜æœºåˆ¶
- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

### 2.3 å¤§æ¨¡å‹é›†æˆä¼˜åŒ–

#### 2.3.1 è¿æ¥ç¨³å®šæ€§
```python
# é‡è¯•æœºåˆ¶å’Œç†”æ–­å™¨
class LLMClientWithRetry:
    def __init__(self, max_retries=3, timeout=30):
        self.max_retries = max_retries
        self.timeout = timeout
        self.circuit_breaker = CircuitBreaker()
    
    async def call_with_retry(self, prompt: str):
        for attempt in range(self.max_retries):
            try:
                return await self.llm_client.generate(prompt)
            except Exception as e:
                if attempt == self.max_retries - 1:
                    raise
                await asyncio.sleep(2 ** attempt)
```

#### 2.3.2 æ€§èƒ½ä¼˜åŒ–
- å¼‚æ­¥è°ƒç”¨å®ç°
- è¯·æ±‚æ‰¹å¤„ç†
- å“åº”ç¼“å­˜æœºåˆ¶
- æµå¼å“åº”æ”¯æŒ

### 2.4 å®‰å…¨æ€§å¢å¼º

#### 2.4.1 è®¤è¯å’Œæˆæƒ
```python
# JWT Tokenå¢å¼º
class JWTManager:
    def __init__(self):
        self.secret_key = settings.SECRET_KEY
        self.algorithm = "HS256"
        self.access_token_expire = timedelta(hours=24)
        self.refresh_token_expire = timedelta(days=7)
    
    def create_tokens(self, user_data: dict):
        access_token = self.create_access_token(user_data)
        refresh_token = self.create_refresh_token(user_data)
        return {"access_token": access_token, "refresh_token": refresh_token}
```

#### 2.4.2 æ•°æ®å®‰å…¨
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤
- CORSé…ç½®ä¼˜åŒ–

### 2.5 é”™è¯¯å¤„ç†å’Œæ—¥å¿—

#### 2.5.1 ç»Ÿä¸€å¼‚å¸¸å¤„ç†
```python
# å…¨å±€å¼‚å¸¸å¤„ç†å™¨
@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    logger.error(f"Unhandled exception: {exc}", exc_info=True)
    return JSONResponse(
        status_code=500,
        content={
            "success": False,
            "message": "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",
            "error_code": "INTERNAL_ERROR"
        }
    )
```

#### 2.5.2 ç»“æ„åŒ–æ—¥å¿—
```python
# æ—¥å¿—é…ç½®
logging.config.dictConfig({
    "version": 1,
    "disable_existing_loggers": False,
    "formatters": {
        "detailed": {
            "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
        }
    },
    "handlers": {
        "file": {
            "class": "logging.handlers.RotatingFileHandler",
            "filename": "app.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 5,
            "formatter": "detailed"
        }
    },
    "root": {
        "level": "INFO",
        "handlers": ["file"]
    }
})
```

## 3. æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

### 3.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§
```python
# APIæ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
@app.middleware("http")
async def performance_monitoring(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    
    logger.info(f"APIè°ƒç”¨: {request.method} {request.url.path} - {process_time:.3f}s")
    response.headers["X-Process-Time"] = str(process_time)
    return response
```

### 3.2 ç¼“å­˜ç­–ç•¥
```python
# Redisç¼“å­˜é›†æˆ
class CacheManager:
    def __init__(self, redis_url: str):
        self.redis = redis.from_url(redis_url)
    
    async def get_or_set(self, key: str, func: Callable, expire: int = 3600):
        cached = await self.redis.get(key)
        if cached:
            return json.loads(cached)
        
        result = await func()
        await self.redis.setex(key, expire, json.dumps(result, default=str))
        return result
```

## 4. å®æ–½è®¡åˆ’

### 4.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰
- [x] ä¿®å¤æ¨¡å—å¯¼å…¥é—®é¢˜
- [ ] å®æ–½ç»Ÿä¸€APIå“åº”æ ¼å¼
- [ ] æ·»åŠ å…¨å±€å¼‚å¸¸å¤„ç†
- [ ] é…ç½®ç»“æ„åŒ–æ—¥å¿—

### 4.2 ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
- [ ] å¤§æ¨¡å‹è°ƒç”¨ä¼˜åŒ–
- [ ] ç¼“å­˜æœºåˆ¶å®æ–½

### 4.3 ç¬¬ä¸‰é˜¶æ®µï¼šå®‰å…¨å¢å¼ºï¼ˆ1-2å¤©ï¼‰
- [ ] JWTè®¤è¯å¢å¼º
- [ ] æ•°æ®åŠ å¯†å®æ–½
- [ ] å®‰å…¨é˜²æŠ¤é…ç½®
- [ ] APIé™æµå®æ–½

### 4.4 ç¬¬å››é˜¶æ®µï¼šç›‘æ§å’Œæµ‹è¯•ï¼ˆ1-2å¤©ï¼‰
- [ ] æ€§èƒ½ç›‘æ§å®æ–½
- [ ] å‹åŠ›æµ‹è¯•
- [ ] å®‰å…¨æµ‹è¯•
- [ ] æ–‡æ¡£æ›´æ–°

## 5. æŠ€æœ¯é€‰å‹å»ºè®®

### 5.1 æ¨èæŠ€æœ¯æ ˆ
- **Webæ¡†æ¶**: FastAPI (å·²ä½¿ç”¨)
- **æ•°æ®åº“**: PostgreSQL (ç”Ÿäº§ç¯å¢ƒæ¨è)
- **ç¼“å­˜**: Redis
- **æ¶ˆæ¯é˜Ÿåˆ—**: Celery + Redis
- **ç›‘æ§**: Prometheus + Grafana
- **æ—¥å¿—**: ELK Stack (Elasticsearch + Logstash + Kibana)

### 5.2 å¼€å‘å·¥å…·
- **APIæµ‹è¯•**: Postman/Insomnia
- **æ•°æ®åº“ç®¡ç†**: DBeaver/pgAdmin
- **æ€§èƒ½æµ‹è¯•**: Locust/Apache Bench
- **ä»£ç è´¨é‡**: Black + isort + flake8

## 6. é¢„æœŸæ•ˆæœ

### 6.1 æ€§èƒ½æå‡
- APIå“åº”æ—¶é—´å‡å°‘50%
- æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡æå‡60%
- å¤§æ¨¡å‹è°ƒç”¨æˆåŠŸç‡è¾¾åˆ°99%
- ç³»ç»Ÿå¹¶å‘å¤„ç†èƒ½åŠ›æå‡3å€

### 6.2 å¼€å‘æ•ˆç‡
- ç»Ÿä¸€çš„å¼€å‘è§„èŒƒå’Œå·¥å…·
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯
- è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹
- è¯¦ç»†çš„APIæ–‡æ¡£å’Œç›‘æ§

### 6.3 ç³»ç»Ÿç¨³å®šæ€§
- 99.9%çš„ç³»ç»Ÿå¯ç”¨æ€§
- å®Œå–„çš„é”™è¯¯æ¢å¤æœºåˆ¶
- å®æ—¶ç›‘æ§å’Œå‘Šè­¦
- æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤

## 7. é£é™©è¯„ä¼°å’Œåº”å¯¹

### 7.1 æŠ€æœ¯é£é™©
- **é£é™©**: å¤§æ¨¡å‹APIè°ƒç”¨ä¸ç¨³å®š
- **åº”å¯¹**: å®æ–½é‡è¯•æœºåˆ¶ã€ç†”æ–­å™¨å’Œé™çº§ç­–ç•¥

### 7.2 æ€§èƒ½é£é™©
- **é£é™©**: æ•°æ®é‡å¢é•¿å¯¼è‡´æ€§èƒ½ä¸‹é™
- **åº”å¯¹**: æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€ç¼“å­˜ä¼˜åŒ–

### 7.3 å®‰å…¨é£é™©
- **é£é™©**: æ•°æ®æ³„éœ²å’Œæ”»å‡»
- **åº”å¯¹**: å¤šå±‚å®‰å…¨é˜²æŠ¤ã€å®šæœŸå®‰å…¨å®¡è®¡

---

**æ³¨æ„**: æœ¬æ–¹æ¡ˆåŸºäºå½“å‰é¡¹ç›®æ¶æ„åˆ†æåˆ¶å®šï¼Œå®æ–½è¿‡ç¨‹ä¸­éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚å»ºè®®åˆ†é˜¶æ®µå®æ–½ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå¼€å‘æ•ˆç‡ã€‚